1) Outbound sending (works today with your sandbox)
A) Add secrets (Replit → Secrets)
MAILGUN_API_KEY = <the key Mailgun showed you>
MAILGUN_DOMAIN  = sandbox5137cafd65f140bcbb0df0ba18b06383.mailgun.org
MAILGUN_BASE_URL = https://api.mailgun.net

B) Authorize recipients (Mailgun UI)

Sandbox can only send to Authorized Recipients. In Mailgun:

Sending → Domains → your sandbox → Authorized Recipients

Add/verify krispauly7@gmail.com (and anyone else you’ll test)

C) Quick send test (already wired in our server)

Replit shell:

python - <<'PY'
from email_send import mg_send
print(mg_send("krispauly7@gmail.com","TEAIM test","Mailgun sandbox: it lives."))
PY


You should get an email from postmaster@sandbox....

You can also hit our API if you added /onboarding/send:
curl -X POST "https://<your-app>/api/onboarding/send" -H "Content-Type: application/json" -d '{"org_id":"<ORG>","project_id":"<PROJ>","template_key":"metrics","to_email":"krispauly7@gmail.com","project_code":"WD-ACME","first_name":"Kris"}'

2) Inbound receiving (email dropbox) – use a custom domain

Sandbox ≠ reliable for inbound/webhooks. For the dropbox, set a real domain like mail.teaim.app.

A) Add custom domain in Mailgun

Sending → Add New Domain → mail.teaim.app

Add the DNS records it gives you:

MX records (receiving)

TXT SPF

TXT DKIM

CNAME tracking (optional)

Wait until all show Verified

B) Add a Route to our webhook

Receiving → Routes → Create Route:

Filter: match_recipient("ingest@teaim.app")

Actions (in this order):

forward("https://<YOUR-REPLIT-URL>/api/email/mailgun")

store()

Priority: 1

Save

C) Add signing key secret (verifies webhooks)

Mailgun → Domain → Security → copy Signing key.
Replit → Secrets:

MAILGUN_SIGNING_KEY = <that signing key>
EMAIL_ALLOWLIST = client.com,partner.com     # optional sender domains
BUCKET = project-artifacts                    # already set


That’s it for inbound config—our FastAPI endpoint /api/email/mailgun will verify HMAC, allowlist the sender, parse #proj:WD-ACME, fetch/store attachments, and push content into the dashboard (actions/risks/decisions/integrations/workstreams).

3) Sanity tests (copy/paste)
A) Send (sandbox)
python - <<'PY'
from email_send import mg_send
print(mg_send("krispauly7@gmail.com","TEAIM test","Mailgun sandbox outbounds are good."))
PY

B) Inbound developer test (no Mailgun needed)

Upload minutes via dev endpoint; TEAIM will parse and update the dashboard:

BASE="https://<YOUR-REPLIT-URL>/api"
ORG="<ORG_UUID>"
PROJ="<PROJ_UUID>"

cat > /tmp/minutes.txt <<'TXT'
Payroll WG – Decisions: retro v2. Risk: SFTP cert expiry (High).
Action: Sam to deliver cert by 2025-09-22. ADP → Workday; Workday → GL.
TXT

curl -s -X POST "$BASE/email/inbound-dev" \
  -H "Content-Type: application/json" -d @- <<JSON
{"subject":"WG minutes #proj:WD-ACME","from":"lead@client.com",
 "attachments":[{"filename":"2025-09-18.txt","content_type":"text/plain","data_b64":"$(base64 -w0 /tmp/minutes.txt)"}]}
JSON


Refresh Dashboard:

Pending shows new actions

Red Flags shows the High risk

Integrations & Tech lists “ADP → Workday”, “Workday → GL”

C) Real inbound via Mailgun (after DNS/Route)

Email ingest@teaim.app with subject including #proj:WD-ACME and attach minutes.
Check Mailgun Logs → your webhook returns 200.
Dashboard updates as above.

4) Common gotchas (fast fixes)

403 “bad signature” → MAILGUN_SIGNING_KEY wrong/missing.

404 “table not found” → in Supabase run:

grant usage on schema public to anon, authenticated, service_role;
grant select, insert, update, delete on all tables in schema public to service_role;
grant usage, select on all sequences in schema public to service_role;
notify pgrst, 'reload schema';


Sandbox sends but doesn’t receive → expected; inbound needs a custom domain + Route.

No email arrives from sandbox → add the recipient under Authorized Recipients.

5) Optional: quick cURL send (no Python)
curl -s --user "api:$MAILGUN_API_KEY" \
  https://api.mailgun.net/v3/sandbox5137cafd65f140bcbb0df0ba18b06383.mailgun.org/messages \
  -F from="TEAIM PMO <postmaster@sandbox5137cafd65f140bcbb0df0ba18b06383.mailgun.org>" \
  -F to="Kris Pauly <krispauly7@gmail.com>" \
  -F subject="TEAIM test via cURL" \
  -F text="Sandbox says hi."
