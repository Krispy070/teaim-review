import React, { useState, createContext, useContext, useEffect, Suspense, lazy } from 'react'
import { Routes, Route, NavLink, useLocation } from 'react-router-dom'
import { QueryClientProvider } from "@tanstack/react-query"
import { queryClient } from "./lib/queryClient"
import { Toaster } from "@/components/ui/toaster"
import { TooltipProvider } from "@/components/ui/tooltip"
import { AuthProvider, AuthGuard } from "./contexts/AuthContext"
import { isBrandV2 } from "@/lib/brand"
import { initTheme } from "./lib/theme"
import NotificationDrawer from "@/components/NotificationDrawer"
import SidebarV2 from "@/components/SidebarV2"
import ChatDock from './components/ChatDock'
import SpotlightSearch from './components/SpotlightSearch'
import ImpersonateBar from './components/ImpersonateBar'
import PresenceIndicator from './components/PresenceIndicator'
import PresenceTracker from './components/PresenceTracker'
import MainDashboard, { LiveDashboardWidgets, FunctionalAreas } from './components/Dashboard'
import DashboardV2 from './pages/DashboardV2'
import ProjectsAdmin from './pages/ProjectsAdmin'
import ProjectWizard from './pages/ProjectWizard'
import ProjectStages from './pages/ProjectStages'
import AdminMembers from './pages/AdminMembers'
import TeamSubscriptions from './components/TeamSubscriptions'
import AdminEmailSend from './components/AdminEmailSend'
import ExternalSignOff from './pages/ExternalSignOff'
import SignOffSuccess from './pages/SignOffSuccess'
import InviteAccept from './pages/InviteAccept'
import ActionsKanban from './pages/ActionsKanban'
import ActionsList from './pages/ActionsList'
import TeamAccess from './pages/TeamAccess'
import UpdatesReview from './pages/UpdatesReview'
import Stages from './pages/Stages'
import StageWizard from './pages/StageWizard'
import NotificationBell from './components/NotificationBell'
import NotificationToaster from './components/NotificationToaster'
import BrandedHeader from './components/BrandedHeader'
import { getJSON } from "@/lib/authFetch"
import ErrorBoundary from './components/ErrorBoundary'
import AppShell from "@/components/AppShell"
import ScrollToTop from "@/components/ScrollToTop"
import { RoleGate } from '@/components/ui/role-gate'
import ProjectGuard from '@/components/ProjectGuard'
import ProjectSelect from '@/pages/ProjectSelect'
import ProjectLayout from '@/components/ProjectLayout'
import { Navigate } from 'react-router-dom'
import TimelinePage from '@/pages/Timeline'
import Login from '@/pages/Login'
import ForgotPassword from '@/pages/ForgotPassword'
import Profile from '@/pages/Profile'
import { AppFrame } from './components/layout/AppFrame'
import { Sidebar as LayoutSidebar } from './components/layout/Sidebar'

// Lazy loaded heavy components
const Library = lazy(() => import('./pages/Library'))
const Meetings = lazy(() => import('./pages/Meetings'))
const BrandingSettings = lazy(() => import('./pages/BrandingSettings'))
const AdminBackups = lazy(() => import('./pages/AdminBackups'))
const AdminHealthDashboard = lazy(() => import('./pages/AdminHealthDashboard'))
const AdminSchemaDoctor = lazy(() => import('./pages/AdminSchemaDoctor'))
const IntegrationsTracker = lazy(() => import('./pages/IntegrationsTracker'))
const ProjectQATools = lazy(() => import('./pages/ProjectQATools'))
const ProjectSmokeRun = lazy(() => import('./pages/ProjectSmokeRun'))
const SignoffComposer = lazy(() => import('./pages/SignoffComposer'))
const ShareLinksManager = lazy(() => import('./pages/ShareLinksManager'))
const AuditTimeline = lazy(() => import('./pages/AuditTimeline'))
const StageTemplateEditor = lazy(() => import('./pages/StageTemplateEditor'))
const RlsSelfTest = lazy(() => import('./pages/RlsSelfTest'))
const DigestPreview = lazy(() => import('./pages/DigestPreview'))
const Reporting = lazy(() => import('./pages/Reporting'))
const Workstreams = lazy(() => import('./pages/Workstreams'))
const WorkstreamArea = lazy(() => import('./pages/WorkstreamArea'))
const ChangeIntake = lazy(() => import('./pages/ChangeIntake'))
const ChangeKanban = lazy(() => import('./pages/ChangeKanban'))
const ChangeList = lazy(() => import('./pages/ChangeList'))
const OwnerDashboard = lazy(() => import('./pages/OwnerDashboard'))
const Releases = lazy(() => import('./pages/Releases'))
const AdminAreaOwners = lazy(() => import('./pages/AdminAreaOwners'))
const TestRunner = lazy(() => import('./pages/TestRunner'))

// Loading fallback component
const PageLoader = () => (
  <div className="flex items-center justify-center p-8">
    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
  </div>
)

// Lazy wrapper for suspense
const LazyWrapper = ({ children }) => (
  <Suspense fallback={<PageLoader />}>
    {children}
  </Suspense>
)

// lightweight stubs for now:
const Page = ({title, children}) => (<div className="space-y-4"><h2 className="text-xl font-semibold">{title}</h2>{children}</div>)

// Navigation wrapper to ensure all pages have sidebar
const PageWithNavigation = ({ children }) => {
  return (
    <AppFrame sidebar={<LayoutSidebar />}>
      {children}
    </AppFrame>
  )
}

const OrgCtx = createContext(null)
export const useOrg = () => useContext(OrgCtx)

export default function App(){
  const [projectId, setProjectId] = useState('e1ec6ad0-a4e8-45dd-87b0-e123776ffe6e')
  const [orgId, setOrgId] = useState('87654321-4321-4321-4321-cba987654321')
  const [userRole, setUserRole] = useState('admin')
  
  // Initialize theme and get role from dev auth or environment
  useEffect(() => {
    // Initialize TEAIM theme system
    initTheme();
    
    try {
      const devAuth = JSON.parse(localStorage.getItem("kap.devAuth") || "null");
      if (devAuth?.role) {
        setUserRole(devAuth.role);
      } else {
        setUserRole(import.meta.env.VITE_DEV_ROLE || 'admin');
      }
    } catch {
      setUserRole(import.meta.env.VITE_DEV_ROLE || 'admin');
    }
  }, []);
  
  const value = { projectId, setProjectId, orgId, setOrgId, userRole, setUserRole }

  return (
    <QueryClientProvider client={queryClient}>
      <TooltipProvider>
        <AuthProvider>
          <AppContent value={value} />
        </AuthProvider>
      </TooltipProvider>
    </QueryClientProvider>
  )
}

function AppContent({ value }) {
  const location = useLocation()
  const isPublicSignoffRoute = location.pathname.startsWith('/signoff')
  const isPublicInviteRoute = location.pathname.startsWith('/invite')
  const isLoginRoute = location.pathname === '/login'
  const brandV2 = isBrandV2()
  
  // Extract userRole from value for RoleGate usage
  const { userRole } = value

  if (isPublicSignoffRoute) {
    // Public layout for external signer token pages
    return (
      <div className="min-h-screen bg-slate-950 text-slate-100">
        <Routes>
          <Route path="/signoff/:token" element={<ExternalSignOff />} />
          <Route path="/signoff/success" element={<SignOffSuccess />} />
        </Routes>
        <Toaster />
      </div>
    )
  }

  if (isPublicInviteRoute) {
    // Public layout for invite token acceptance
    return (
      <div className="min-h-screen bg-slate-950 text-slate-100">
        <Routes>
          <Route path="/invite/accept/:token" element={<InviteAccept />} />
        </Routes>
        <Toaster />
      </div>
    )
  }

  if (isLoginRoute || location.pathname === '/auth/forgot-password') {
    // Clean layout for login and auth pages
    return (
      <div className="min-h-screen bg-slate-950 text-slate-100">
        <Routes>
          <Route path="/login" element={<Login />} />
          <Route path="/auth/forgot-password" element={<ForgotPassword />} />
        </Routes>
        <Toaster />
      </div>
    )
  }

  // Authenticated layout for internal users
  return (
    <AuthGuard>
      <OrgCtx.Provider value={value}>
        <div className={brandV2 ? "brand-v2 min-h-screen" : "min-h-screen bg-slate-950 text-slate-100"}>
          <ErrorBoundary>
            {brandV2 ? (
              // Brand V2 uses its own layout system via DashboardV2's AppFrame
              <>
                <ScrollToTop />
                <Routes>
                  <Route path="/" element={brandV2 ? <DashboardV2 /> : <MainDashboard orgId={value.orgId} projectId={value.projectId} />} />
                  <Route path="/dashboard" element={brandV2 ? <DashboardV2 /> : <MainDashboard orgId={value.orgId} projectId={value.projectId} />} />
                  <Route path="/timeline" element={<TimelinePage />} />
                  <Route path="/workstreams" element={<LazyWrapper><Workstreams /></LazyWrapper>} />
                  <Route path="/integrations" element={<Page title="Integrations & Tech">Coming soon</Page>} />
                  <Route path="/actions" element={<ActionsKanban />} />
                  <Route path="/actions/kanban" element={<ActionsKanban />} />
                  <Route path="/documents" element={<LazyWrapper><Library orgId={value.orgId} projectId={value.projectId} /></LazyWrapper>} />
                  <Route path="/meetings" element={<LazyWrapper><Meetings projectId={value.projectId} /></LazyWrapper>} />
                  <Route path="/training" element={<Page title="Training">Coming soon</Page>} />
                  <Route path="/testing" element={<Page title="Testing">Coming soon</Page>} />
                  <Route path="/logistics" element={<Page title="Logistics">Coming soon</Page>} />
                  <Route path="/data" element={<LazyWrapper><Reporting /></LazyWrapper>} />
                  <Route path="/reporting" element={<LazyWrapper><Reporting /></LazyWrapper>} />
                  <Route path="/wellness" element={<Page title="Team Wellness">Coming soon</Page>} />
                  <Route path="/financials" element={<Page title="Financials">Coming soon</Page>} />
                  <Route path="/team" element={<TeamAccess />} />
                  <Route path="/updates" element={<UpdatesReview />} />
                  <Route path="/admin-email" element={<Page title="Email Center">Coming soon</Page>} />
                  <Route path="/admin/projects" element={<ProjectsAdmin />} />
                  <Route path="/admin/members" element={<AdminMembers />} />
                  <Route path="/admin/branding" element={<RoleGate allow={['owner', 'admin']} role={userRole}><LazyWrapper><BrandingSettings /></LazyWrapper></RoleGate>} />
                  <Route path="/admin/stage-templates" element={<RoleGate allow={['owner', 'admin', 'pm']} role={userRole}><LazyWrapper><StageTemplateEditor /></LazyWrapper></RoleGate>} />
                  {/* Project-scoped routes with proper nested structure - ALL under ProjectGuard */}
                  <Route path="/projects/:projectId" element={<ProjectLayout />}>
                    <Route index element={<Navigate to="dashboard" replace />} />
                    <Route path="dashboard" element={brandV2 ? <DashboardV2 /> : <MainDashboard orgId={value.orgId} projectId={value.projectId} />} />
                    <Route path="timeline" element={<TimelinePage />} />
                    <Route path="documents" element={<LazyWrapper><Library orgId={value.orgId} projectId={value.projectId} /></LazyWrapper>} />
                    <Route path="meetings" element={<LazyWrapper><Meetings projectId={value.projectId} /></LazyWrapper>} />
                    <Route path="updates/review" element={<UpdatesReview />} />
                    <Route path="updates" element={<Navigate to="updates/review" replace />} />
                    <Route path="actions" element={<Navigate to="actions/list" replace />} />
                    <Route path="chat" element={<Page title="Chat">Coming soon</Page>} />
                    <Route path="analytics" element={<Navigate to="reporting" replace />} />
                    <Route path="reports" element={<Navigate to="reporting" replace />} />
                    <Route path="signoffs" element={<Navigate to="signoff/compose" replace />} />
                    <Route path="stages/manage" element={<Stages />} />
                    <Route path="stages/wizard" element={<StageWizard />} />
                    <Route path="signoff/compose" element={<LazyWrapper><SignoffComposer /></LazyWrapper>} />
                    <Route path="signoff/docs" element={<Page title="Sign-Off Documents">Coming soon</Page>} />
                    <Route path="admin/ops" element={<Page title="Operations">Coming soon</Page>} />
                    <Route path="admin/branding" element={<RoleGate allow={['owner', 'admin']} role={userRole}><LazyWrapper><BrandingSettings /></LazyWrapper></RoleGate>} />
                    <Route path="admin/digest-preview" element={<RoleGate allow={['owner', 'admin', 'pm', 'lead']} role={userRole}><LazyWrapper><DigestPreview /></LazyWrapper></RoleGate>} />
                    <Route path="admin/method" element={<Page title="Method Insights">Coming soon</Page>} />
                    <Route path="admin/invite" element={<AdminMembers />} />
                    <Route path="admin/team-access" element={<PageWithNavigation><TeamAccess /></PageWithNavigation>} />
                    <Route path="admin/backups" element={<PageWithNavigation><LazyWrapper><AdminBackups projectId={value.projectId} /></LazyWrapper></PageWithNavigation>} />
                    <Route path="admin/rls-selftest" element={<PageWithNavigation><LazyWrapper><RlsSelfTest /></LazyWrapper></PageWithNavigation>} />
                    <Route path="admin/health" element={<LazyWrapper><AdminHealthDashboard projectId={value.projectId} /></LazyWrapper>} />
                    <Route path="admin/schema-doctor" element={<LazyWrapper><AdminSchemaDoctor /></LazyWrapper>} />
                    <Route path="admin/integrations" element={<LazyWrapper><IntegrationsTracker projectId={value.projectId} /></LazyWrapper>} />
                    <Route path="admin/share-links" element={<LazyWrapper><ShareLinksManager /></LazyWrapper>} />
                    <Route path="admin/audit-timeline" element={<LazyWrapper><AuditTimeline /></LazyWrapper>} />
                    <Route path="admin/qa" element={<LazyWrapper><ProjectQATools /></LazyWrapper>} />
                    <Route path="admin/smoke-run" element={<LazyWrapper><ProjectSmokeRun /></LazyWrapper>} />
                    <Route path="admin/test" element={<LazyWrapper><TestRunner /></LazyWrapper>} />
                    {/* Additional stub routes for complete navigation */}
                    <Route path="workstreams" element={<LazyWrapper><Workstreams /></LazyWrapper>} />
                    <Route path="workstreams/:areaKey" element={<LazyWrapper><WorkstreamArea /></LazyWrapper>} />
                    <Route path="changes/intake" element={<LazyWrapper><ChangeIntake /></LazyWrapper>} />
                    <Route path="changes/board" element={<LazyWrapper><ChangeKanban /></LazyWrapper>} />
                    <Route path="changes/list" element={<LazyWrapper><ChangeList /></LazyWrapper>} />
                    <Route path="team/owner" element={<LazyWrapper><OwnerDashboard /></LazyWrapper>} />
                    <Route path="releases" element={<LazyWrapper><Releases /></LazyWrapper>} />
                    <Route path="team/area-owners" element={<LazyWrapper><AdminAreaOwners /></LazyWrapper>} />
                    <Route path="training" element={<Page title="Training">Coming soon</Page>} />
                    <Route path="testing" element={<Page title="Testing">Coming soon</Page>} />
                    <Route path="logistics" element={<Page title="Logistics">Coming soon</Page>} />
                    <Route path="actions/list" element={<Page title="Actions">Coming soon</Page>} />
                    <Route path="actions/kanban" element={<ActionsKanban />} />
                    <Route path="stages" element={<Page title="Stage Sign-Off">Coming soon</Page>} />
                    <Route path="integrations" element={<Page title="Integrations & Tech">Coming soon</Page>} />
                    <Route path="reporting" element={<LazyWrapper><Reporting /></LazyWrapper>} />
                    <Route path="wellness" element={<Page title="Team Wellness">Coming soon</Page>} />
                    <Route path="financials" element={<Page title="Financials">Coming soon</Page>} />
                    <Route path="admin/projects" element={<ProjectsAdmin />} />
                    <Route path="admin/comms" element={<Page title="Email Center">Coming soon</Page>} />
                    <Route path="admin/qa-tools" element={<LazyWrapper><ProjectQATools /></LazyWrapper>} />
                  </Route>
                  
                  {/* Safety redirect for malformed project URLs */}
                  <Route path="/projects/undefined/*" element={<Navigate to="/projects/select" replace />} />
                  
                  {/* Non-project routes */}
                  <Route path="/projects/select" element={<ProjectSelect />} />
                  <Route path="/projects/new" element={<ProjectWizard />} />
                  <Route path="/projects/stages" element={<ProjectStages projectId={value.projectId} />} />
                  <Route path="/profile" element={<Profile />} />
                  <Route path="*" element={<Page title="Not Found">Check the URL.</Page>} />
                </Routes>
                <ChatDock orgId={value.orgId} projectId={value.projectId} />
                <SpotlightSearch />
                <ImpersonateBar />
                <div className="fixed right-3 top-3 z-[96]">
                  <NotificationDrawer />
                </div>
              </>
            ) : (
              // Original layout system for non Brand V2
              <AppShell sidebar={<Sidebar />}>
                <ScrollToTop />
                <Topbar />
                <main className="max-w-7xl mx-auto px-4 py-6">
                  <Routes>
                    <Route path="/" element={<MainDashboard orgId={value.orgId} projectId={value.projectId} />} />
                    <Route path="/dashboard" element={<MainDashboard orgId={value.orgId} projectId={value.projectId} />} />
                    <Route path="/timeline" element={<Page title="Timeline">Coming soon</Page>} />
                    <Route path="/workstreams" element={<LazyWrapper><Workstreams /></LazyWrapper>} />
                    <Route path="/integrations" element={<Page title="Integrations & Tech">Coming soon</Page>} />
                    <Route path="/actions" element={<ActionsKanban />} />
                    <Route path="/actions/kanban" element={<ActionsKanban />} />
                    <Route path="/documents" element={<LazyWrapper><Library orgId={value.orgId} projectId={value.projectId} /></LazyWrapper>} />
                    <Route path="/meetings" element={<LazyWrapper><Meetings projectId={value.projectId} /></LazyWrapper>} />
                    <Route path="/training" element={<Page title="Training">Coming soon</Page>} />
                    <Route path="/testing" element={<Page title="Testing">Coming soon</Page>} />
                    <Route path="/logistics" element={<Page title="Logistics">Coming soon</Page>} />
                    <Route path="/data" element={<LazyWrapper><Reporting /></LazyWrapper>} />
                    <Route path="/wellness" element={<Page title="Team Wellness">Coming soon</Page>} />
                    <Route path="/financials" element={<Page title="Financials">Coming soon</Page>} />
                    <Route path="/team" element={<TeamAccess />} />
                    <Route path="/updates" element={<UpdatesReview />} />
                    <Route path="/admin-email" element={<Page title="Email Center">Coming soon</Page>} />
                    <Route path="/admin/projects" element={<ProjectsAdmin />} />
                    <Route path="/admin/members" element={<AdminMembers />} />
                    <Route path="/admin/branding" element={<RoleGate allow={['owner', 'admin']} role={userRole}><LazyWrapper><BrandingSettings /></LazyWrapper></RoleGate>} />
                    <Route path="/admin/stage-templates" element={<RoleGate allow={['owner', 'admin', 'pm']} role={userRole}><LazyWrapper><StageTemplateEditor /></LazyWrapper></RoleGate>} />
                    {/* Project-scoped routes with proper nested structure - ALL under ProjectGuard */}
                    <Route path="/projects/:projectId" element={<ProjectLayout />}>
                      <Route index element={<Navigate to="dashboard" replace />} />
                      <Route path="dashboard" element={<MainDashboard orgId={value.orgId} projectId={value.projectId} />} />
                      <Route path="timeline" element={<TimelinePage />} />
                      <Route path="documents" element={<LazyWrapper><Library orgId={value.orgId} projectId={value.projectId} /></LazyWrapper>} />
                      <Route path="meetings" element={<LazyWrapper><Meetings projectId={value.projectId} /></LazyWrapper>} />
                      <Route path="updates/review" element={<UpdatesReview />} />
                      <Route path="stages/manage" element={<Stages />} />
                      <Route path="stages/wizard" element={<StageWizard />} />
                      <Route path="signoff/compose" element={<LazyWrapper><SignoffComposer /></LazyWrapper>} />
                      <Route path="signoff/docs" element={<Page title="Sign-Off Documents">Coming soon</Page>} />
                      <Route path="admin/ops" element={<Page title="Operations">Coming soon</Page>} />
                      <Route path="admin/branding" element={<RoleGate allow={['owner', 'admin']} role={userRole}><LazyWrapper><BrandingSettings /></LazyWrapper></RoleGate>} />
                      <Route path="admin/digest-preview" element={<RoleGate allow={['owner', 'admin', 'pm', 'lead']} role={userRole}><LazyWrapper><DigestPreview /></LazyWrapper></RoleGate>} />
                      <Route path="admin/method" element={<Page title="Method Insights">Coming soon</Page>} />
                      <Route path="admin/invite" element={<AdminMembers />} />
                      <Route path="admin/team-access" element={<TeamAccess />} />
                      <Route path="admin/backups" element={<LazyWrapper><AdminBackups projectId={value.projectId} /></LazyWrapper>} />
                      <Route path="admin/rls-selftest" element={<LazyWrapper><RlsSelfTest /></LazyWrapper>} />
                      <Route path="admin/health" element={<LazyWrapper><AdminHealthDashboard projectId={value.projectId} /></LazyWrapper>} />
                      <Route path="admin/schema-doctor" element={<LazyWrapper><AdminSchemaDoctor /></LazyWrapper>} />
                      <Route path="admin/integrations" element={<LazyWrapper><IntegrationsTracker projectId={value.projectId} /></LazyWrapper>} />
                      <Route path="admin/share-links" element={<LazyWrapper><ShareLinksManager /></LazyWrapper>} />
                      <Route path="admin/audit-timeline" element={<LazyWrapper><AuditTimeline /></LazyWrapper>} />
                      <Route path="admin/qa" element={<LazyWrapper><ProjectQATools /></LazyWrapper>} />
                      <Route path="admin/smoke-run" element={<LazyWrapper><ProjectSmokeRun /></LazyWrapper>} />
                      <Route path="admin/test" element={<LazyWrapper><TestRunner /></LazyWrapper>} />
                      {/* Additional stub routes for complete navigation */}
                      <Route path="workstreams" element={<LazyWrapper><Workstreams /></LazyWrapper>} />
                      <Route path="workstreams/:areaKey" element={<LazyWrapper><WorkstreamArea /></LazyWrapper>} />
                      <Route path="changes/intake" element={<LazyWrapper><ChangeIntake /></LazyWrapper>} />
                      <Route path="changes/board" element={<LazyWrapper><ChangeKanban /></LazyWrapper>} />
                      <Route path="changes/list" element={<LazyWrapper><ChangeList /></LazyWrapper>} />
                      <Route path="team/owner" element={<LazyWrapper><OwnerDashboard /></LazyWrapper>} />
                      <Route path="releases" element={<LazyWrapper><Releases /></LazyWrapper>} />
                      <Route path="team/area-owners" element={<LazyWrapper><AdminAreaOwners /></LazyWrapper>} />
                      <Route path="training" element={<Page title="Training">Coming soon</Page>} />
                      <Route path="testing" element={<Page title="Testing">Coming soon</Page>} />
                      <Route path="logistics" element={<Page title="Logistics">Coming soon</Page>} />
                      <Route path="actions/list" element={<ActionsKanban />} />
                      <Route path="actions/kanban" element={<ActionsKanban />} />
                      <Route path="stages" element={<Page title="Stage Sign-Off">Coming soon</Page>} />
                      <Route path="integrations" element={<Page title="Integrations & Tech">Coming soon</Page>} />
                      <Route path="reporting" element={<LazyWrapper><Reporting /></LazyWrapper>} />
                      <Route path="wellness" element={<Page title="Team Wellness">Coming soon</Page>} />
                      <Route path="financials" element={<Page title="Financials">Coming soon</Page>} />
                      <Route path="admin/projects" element={<ProjectsAdmin />} />
                      <Route path="admin/comms" element={<Page title="Email Center">Coming soon</Page>} />
                      <Route path="admin/qa-tools" element={<LazyWrapper><ProjectQATools /></LazyWrapper>} />
                    </Route>
                    
                    {/* Safety redirect for malformed project URLs */}
                    <Route path="/projects/undefined/*" element={<Navigate to="/projects/select" replace />} />
                    
                    {/* Non-project routes */}
                    <Route path="/projects/select" element={<ProjectSelect />} />
                    <Route path="/projects/new" element={<ProjectWizard />} />
                    <Route path="/projects/stages" element={<ProjectStages projectId={value.projectId} />} />
                    <Route path="/profile" element={<Profile />} />
                    <Route path="*" element={<Page title="Not Found">Check the URL.</Page>} />
                  </Routes>
                </main>
                <ChatDock orgId={value.orgId} projectId={value.projectId} />
                <SpotlightSearch />
                <ImpersonateBar />
              </AppShell>
            )}
        </ErrorBoundary>
        <Toaster />
      </div>
    </OrgCtx.Provider>
    </AuthGuard>
  )
}

function Sidebar(){
  const { projectId, userRole } = useOrg()
  const [uCount, setUCount] = useState(0);
  useEffect(()=>{ 
    let alive=true; 
    (async ()=>{ try{ const d=await getJSON(`/api/updates/count?project_id=${projectId}`); if(alive) setUCount(d.count||0);}catch{} })();
    const t=setInterval(async()=>{ try{ const d=await getJSON(`/api/updates/count?project_id=${projectId}`); if(alive) setUCount(d.count||0);}catch{} }, 15000);
    return ()=>{alive=false; clearInterval(t)};
  },[projectId]);
  const link = (to, label) => (
    <NavLink to={to}
      className={({isActive}) => `block px-4 py-2 rounded-lg text-sm ${isActive ? 'bg-slate-800 text-white' : 'text-slate-300 hover:bg-slate-800/60'}`}
      data-testid={`nav-${label.toLowerCase().replace(/[^a-z0-9]/g, '-')}`}>
      {label}
    </NavLink>
  )
  return (
    <aside className="w-60 border-r border-slate-800 p-3 sticky top-0 h-screen overflow-y-auto">
      <div className="font-bold mb-3">TEAIM</div>
      {link('/dashboard','Dashboard')}
      {link('/timeline','Timeline')}
      {link('/workstreams','Workstreams')}
      {link('/integrations','Integrations & Tech')}
      {link('/actions','Actions')}
      {link('/actions/kanban','Actions Kanban')}
      {link('/projects/stages','Stage Sign-Off')}
      {link(`/projects/${projectId}/stages/manage`,'Manage Stages')}
      {link(`/projects/${projectId}/stages/wizard`,'Stage Wizard')}
      {link(`/projects/${projectId}/signoff/compose`,'Compose Sign-Off Package')}
      {link('/documents','Documents')}
      {link('/meetings','Meeting Summaries')}
      {link('/training','Training')}
      {link('/testing','Testing')}
      {link('/logistics','Logistics')}
      {link('/data','Data & Reporting')}
      {link('/wellness','Team Wellness')}
      {link('/financials','Financials')}
      <div className="mt-4 pt-4 border-t border-slate-700">
        <div className="text-xs uppercase tracking-wider text-slate-400 mb-2">Admin</div>
        {link('/admin/projects','Projects Admin')}
        {link(`/projects/${projectId}/admin/health`,'System Health')}
        {link(`/projects/${projectId}/admin/integrations`,'Integrations Tracker')}
        {link('/admin/members','Members')}
        {link('/admin/branding','Branding & Logos')}
        {link(`/projects/${projectId}/admin/digest-preview`,'Digest Preview')}
        {link(`/projects/${projectId}/admin/backups`,'Admin Backups')}
        <RoleGate allow={['owner', 'admin']} role={userRole}>
          {link(`/projects/${projectId}/admin/rls-selftest`,'RLS Self-Test')}
          {link(`/projects/${projectId}/admin/schema-doctor`,'Schema Doctor')}
        </RoleGate>
        {link(`/projects/${projectId}/admin/audit-timeline`,'Audit Timeline')}
        {link(`/projects/${projectId}/admin/qa`,'QA Tools')}
        {link(`/projects/${projectId}/admin/smoke-run`,'Smoke Runner')}
        {link(`/projects/${projectId}/admin/test`,'Test Runner')}
        {link('/projects/new','New Project')}
        {link('/team','Team Management')}
        <div className="flex items-center justify-between">
          {link('/updates','PM Update Monitor')}
          {uCount > 0 && <span className="ml-2 text-[10px] px-1.5 py-0.5 rounded-full bg-red-500 text-white font-semibold" data-testid="badge-pending-count">{uCount}</span>}
        </div>
        {link('/admin-email','Email Center')}
      </div>
      <div className="pb-8"></div>
    </aside>
  )
}

function Topbar(){
  const { orgId, projectId, setOrgId, setProjectId } = useOrg()
  const brandV2 = isBrandV2()
  
  if (brandV2) {
    console.log('üîç Topbar Brand V2 rendering - BASIC TEST');
    return (
      <header className="border-b" style={{borderColor: 'var(--brand-primary, #111111)'}}>
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          {/* Left side - Branding with project awareness */}
          <div className="flex items-center">
            <BrandedHeader variant="compact" showFallback={true} projectId={projectId} />
          </div>
          
          {/* Right side - Controls with brand styling */}
          <div className="flex items-center gap-2">
            <input className="px-2 py-1 border rounded-full text-sm w-48 brand-card"
                   placeholder="org_id (UUID)" value={orgId} onChange={e=>{window.__ORG__=e.target.value||''; setOrgId(e.target.value)}} data-testid="input-org-id" />
            <input className="px-2 py-1 border rounded-full text-sm w-56 brand-card"
                   placeholder="project_id (UUID)" value={projectId} onChange={e=>{window.__PROJ__=e.target.value||''; setProjectId(e.target.value)}} data-testid="input-project-id" />
          </div>
        </div>
      </header>
    )
  }
  
  console.log('üîç Topbar Legacy rendering - BASIC TEST');
  return (
    <header className="border-b border-slate-800">
      <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        {/* Left side - Branding */}
        <div className="flex items-center">
          <BrandedHeader variant="compact" showFallback={true} />
        </div>
        
        {/* Right side - Controls */}
        <div className="flex items-center gap-2">
          <NotificationBell />
          <NotificationToaster />
          <input className="px-2 py-1 border rounded-full text-sm w-48 bg-slate-900 border-slate-700"
                 placeholder="org_id (UUID)" value={orgId} onChange={e=>{window.__ORG__=e.target.value||''; setOrgId(e.target.value)}} data-testid="input-org-id" />
          <input className="px-2 py-1 border rounded-full text-sm w-56 bg-slate-900 border-slate-700"
                 placeholder="project_id (UUID)" value={projectId} onChange={e=>{window.__PROJ__=e.target.value||''; setProjectId(e.target.value)}} data-testid="input-project-id" />
        </div>
      </div>
    </header>
  )
}



function TeamPage(){
  const { orgId, projectId } = useOrg()
  return (
    <div className="space-y-6">
      <TeamSubscriptions orgId={orgId} projectId={projectId} />
    </div>
  )
}

function AdminEmailPage(){
  const { orgId, projectId } = useOrg()
  return (
    <div className="space-y-6">
      <AdminEmailSend orgId={orgId} projectId={projectId} />
    </div>
  )
}

function ProjectsAdminPage(){
  const { orgId } = useOrg()
  return <ProjectsAdmin orgId={orgId} />
}

function ProjectWizardPage(){
  const { orgId, setProjectId } = useOrg()
  return <ProjectWizard 
    orgId={orgId} 
    onComplete={(projectId) => {
      setProjectId(projectId)
      // Could redirect to dashboard or project view
      window.location.href = '/dashboard'
    }} 
  />
}